---
name: sales-manager-database
description: Drizzle ORM + MySQL 스키마, 마이그레이션, 쿼리 패턴을 설명합니다. DB 관련 작업 시 참조하세요.
---

# Sales Manager Database

## 기술 스택

- **ORM**: Drizzle ORM v0.44+
- **DB**: MySQL (mysql2 드라이버)
- **마이그레이션**: drizzle-kit

## 스키마 파일

`drizzle/schema.ts` — 모든 테이블 정의 (단일 파일)

## 도메인 모델

### users (사용자)
```typescript
{ id, openId, name, email, loginMethod, role: 'user'|'admin', createdAt, updatedAt, lastSignedIn }
```

### clients (고객사)
```typescript
{ id, userId, name, industry, contactPerson, contactPhone, contactEmail, address, notes, isActive, ... }
```
- `userId`: 소유한 영업사원

### salesLogs (영업일지)
```typescript
{ id, userId, clientId?, clientName?, contactPerson?, location, visitedAt,
  rawContent,        // 원본 입력
  aiSummary?,        // AI 요약
  aiExtracted?,      // JSON: { nextActions, amount, keywords, sentiment }
  audioUrl?,         // S3 음성 파일
  transcribedText?,  // STT 결과
  isProcessed,       // AI 처리 완료 여부
  ... }
```

### promises (일정)
```typescript
{ id, userId, salesLogId?, clientId?, clientName?, title, description, scheduledAt,
  status: 'scheduled'|'completed'|'canceled'|'overdue',
  reminderSent, isAutoGenerated, ... }
```

### orders (수주)
```typescript
{ id, userId, clientId?, salesLogId?, clientName, productService, amount,
  status: 'proposal'|'negotiation'|'confirmed'|'canceled',
  contractDate?, expectedDeliveryDate?, notes, ... }
```

### deliveries (납품)
```typescript
{ id, userId, orderId, clientName, revenueAmount,
  deliveryStatus: 'pending'|'delivered'|'invoiced'|'paid',
  billingStatus: 'unbilled'|'billed'|'paid',
  deliveredAt?, notes, ... }
```

### attachments (첨부파일)
```typescript
{ id, userId, salesLogId?, fileName, fileKey, fileUrl, mimeType, fileSize, createdAt }
```

## Drizzle 쿼리 패턴

### DB 인스턴스 임포트
```typescript
import { db } from '../db'
import * as schema from '../../drizzle/schema'
import { eq, and, desc, gte, lte } from 'drizzle-orm'
```

### 기본 CRUD
```typescript
// 조회 (userId 격리 필수!)
const items = await db.select()
  .from(schema.clients)
  .where(eq(schema.clients.userId, ctx.user.id))
  .orderBy(desc(schema.clients.createdAt))

// 생성
const [created] = await db.insert(schema.clients)
  .values({ userId: ctx.user.id, name, ... })

// 수정
await db.update(schema.clients)
  .set({ name, updatedAt: new Date() })
  .where(and(
    eq(schema.clients.id, id),
    eq(schema.clients.userId, ctx.user.id)  // 소유권 확인!
  ))

// 삭제
await db.delete(schema.clients)
  .where(and(
    eq(schema.clients.id, id),
    eq(schema.clients.userId, ctx.user.id)
  ))
```

### 타입 사용
```typescript
import type { Client, InsertClient } from '../../drizzle/schema'
```

## 마이그레이션

```bash
# 스키마 변경 후
pnpm db:push
# = drizzle-kit generate && drizzle-kit migrate
```

## 중요 규칙

- **userId 격리**: 모든 쿼리에 `eq(table.userId, ctx.user.id)` 조건 필수
- **타입 사용**: `$inferSelect`, `$inferInsert`로 추론된 타입 사용
- **enum 주의**: DB 컬럼은 `mysqlEnum` 사용, TS 코드에서는 문자열 리터럴 유니온
